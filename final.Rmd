---
title: "Locating Affordable Housing"
author: "Frank Chen"
date: "2024-04-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages}
library(tidyverse)
library(sf)
library(units)
```

```{r load data}
land_use <- st_read("https://opendata.arcgis.com/datasets/e433504739bd41049de5d8f4a22d34ba_0.geojson")
zoning <- st_read("https://opendata.arcgis.com/datasets/0bdb0b5f13774c03abf8dc2f1aa01693_0.geojson")
property <- read.csv("https://opendata-downloads.s3.amazonaws.com/opa_properties_public.csv")
zoning_regulation <- read.csv("D:/Spatial_Optimization/Final/data/zoning.csv")
```

```{r filter}
vacant_land <- land_use %>% 
  filter(C_DIG2 == 91)

r_area <- zoning %>% 
  filter(ZONINGGROUP == "Residential/Residential Mixed-Use")

pub_var <- c("CITY", "PHILA")

city_owned <- property %>% 
  rename(geometry = shape) %>% 
  st_as_sf(wkt = "geometry", crs = 2272) %>% 
  dplyr::select(market_value, category_code_description, owner_1, owner_2) %>% 
  filter(category_code_description == "VACANT LAND") %>% 
  mutate(owner = paste0(owner_1, " ", owner_2)) %>% 
  dplyr::select(-owner_1, -owner_2) %>% 
  filter(str_detect(owner, paste(pub_var, collapse = "|"))) %>% 
  st_transform(st_crs(vacant_land))
```

```{r spatial join}
city_owned_vland <- city_owned %>% 
  st_join(vacant_land, .) %>% 
  filter(! is.na(owner))

parcels <- city_owned_vland %>% 
  st_join(., r_area, join = st_within) %>% 
  filter(! is.na(CODE)) %>% 
  st_transform("ESRI:102728") %>% 
  mutate(area_sqft = as.numeric(set_units(st_area(geometry), "ft^2"))) %>% 
  dplyr::select(C_DIG2, owner, CODE, market_value, area_sqft, geometry)

parcels <- parcels %>% 
  left_join(., zoning_regulation, by = "CODE")

parcels_RSD <- parcels %>% 
  filter(str_detect(CODE, "RSD")) %>% 
  mutate(units = 1)

RM_var <- c("RM2", "RM3", "RM4")

parcels_RSA <- parcels %>% 
  filter(! str_detect(CODE, paste(RM_var, collapse = "|")),
         ! str_detect(CODE, "RSD"),
         area_sqft > min.lot.area) %>% 
  mutate(units = floor(area_sqft * Max.occupied / unit.area))

parcels_RM <- parcels %>% 
  filter(str_detect(CODE, paste(RM_var, collapse = "|")),
         area_sqft > min.lot.area) %>% 
  mutate(units = floor(area_sqft * FAR / unit.area))

final_parcels <- rbind(parcels_RSD, parcels_RSA, parcels_RM)

final_parcels %>% 
  dplyr::select(market_value, units, geometry) %>% 
  st_write("D:/Spatial_Optimization/Final/data/parcels.shp")
```

